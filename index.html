<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fair Grader</title>
    
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles for Animation & App UI -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* --- Welcome Page Animations --- */
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.4s; }
        .delay-3 { animation-delay: 0.6s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .pulse-button {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* --- Main App UI Styles --- */
        .file-drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .file-drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        .result-card {
            /* Fade-in is already defined above */
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        .tab-button {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: #6b7280; /* text-gray-500 */
        }
        .tab-button.active {
            border-bottom-color: #3b82f6; /* border-blue-600 */
            color: #3b82f6; /* text-blue-600 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-100 min-h-screen p-4 md:p-8">

    <!-- Welcome Page Container -->
    <div id="welcome-container" class="flex items-center justify-center" style="min-height: 80vh;">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-xl p-10 md:p-16 text-center overflow-hidden">
            
            <!-- Animated Header -->
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 fade-in">
                Welcome to <span class="text-blue-600">The Fair Grader</span>
            </h1>
            
            <!-- Animated Subtitle -->
            <p class="text-lg md:text-xl text-gray-600 mt-4 fade-in delay-1">
                Your Hybrid AI Grading Assistant
            </p>

            <!-- Animated Info Text -->
            <p class="text-gray-700 mt-8 max-w-lg mx-auto fade-in delay-2">
                This tool combines the power of generative AI with objective keyword analysis. Instantly grade handwritten notes or text, get nuanced feedback in different personas, and save valuable time.
            </p>
            
            <!-- "Get Started" Button (Now a <button>) -->
            <button id="start-app-button" 
               class="inline-block bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 px-10 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out mt-12 text-lg pulse-button">
                Get Started
            </button>
            
        </div>
    </div>

    <!-- Main App Page Container (Hidden by default) -->
    <div id="app-page" class="hidden">
        <div class="bg-white w-full rounded-2xl shadow-xl p-6 md:p-10">
        
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                    The Fair Grader
                </h1>
                <p class="text-lg text-gray-600 mt-2">
                    A Hybrid AI Approach to Automated Grading
                </p>
            </div>
    
            <!-- API Key Input -->
            <div class="mb-6 max-w-2xl mx-auto">
                <label for="api-key" class="block text-sm font-medium text-gray-700 mb-2">
                    Enter Your Gemini API Key
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <!-- Key Icon -->
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                        </svg>
                    </div>
                    <input type="password" id="api-key" class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Paste your API key here...">
                </div>
            </div>
    
            <!-- Input Grid (Questions, Model Answers, Student Answers) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                
                <!-- Column 1: Question Paper -->
                <div class="w-full bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <!-- Question Icon -->
                        <svg class="w-5 h-5 text-gray-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                        </svg>
                        1. Question Paper
                    </label>
                    <!-- Tabs for Q -->
                    <div class="flex border-b border-gray-200 mb-3">
                        <button class="tab-button active" data-tab-for="q" data-mode="image">Upload Image</button>
                        <button class="tab-button" data-tab-for="q" data-mode="text">Paste Text</button>
                    </div>
                    <!-- Image Input for Q -->
                    <div class="file-drop-zone w-full h-48 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-100 transition-colors"
                         id="q-drop-zone">
                        <input type="file" id="question-file" class="hidden" accept="image/*">
                        <div id="q-preview-container" class="text-center p-2">
                            <img id="q-preview" class="hidden max-h-40 mx-auto mb-2 rounded" alt="Question preview">
                            <span id="q-file-name" class="text-sm break-words" data-default-text="Drag & drop or click to upload">Drag & drop or click to upload</span>
                        </div>
                    </div>
                    <!-- Text Input for Q -->
                    <textarea id="question-text" class="hidden w-full h-48 p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste or type questions here..."></textarea>
                </div>
    
                <!-- Column 2: Model Answer -->
                <div class="w-full bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <!-- Check Icon -->
                        <svg class="w-5 h-5 text-green-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        2. Official Answer Key
                    </label>
                    <!-- Tabs for M -->
                    <div class="flex border-b border-gray-200 mb-3">
                        <button class="tab-button active" data-tab-for="m" data-mode="image">Upload Image</button>
                        <button class="tab-button" data-tab-for="m" data-mode="text">Paste Text</button>
                    </div>
                    <!-- Image Input for M -->
                    <div class="file-drop-zone w-full h-48 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-100 transition-colors"
                         id="m-drop-zone">
                        <input type="file" id="model-file" class="hidden" accept="image/*">
                        <div id="m-preview-container" class="text-center p-2">
                            <img id="m-preview" class="hidden max-h-40 mx-auto mb-2 rounded" alt="Model answer preview">
                            <span id="m-file-name" class="text-sm break-words" data-default-text="Drag & drop or click to upload">Drag & drop or click to upload</span>
                        </div>
                    </div>
                    <!-- Text Input for M -->
                    <textarea id="model-text" class="hidden w-full h-48 p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste or type model answers here..."></textarea>
                </div>
    
                <!-- Column 3: Student Answer -->
                <div class="w-full bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <!-- Pen Icon -->
                        <svg class="w-5 h-5 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                        3. Student's Answer Sheet
                    </label>
                    <!-- Tabs for S -->
                    <div class="flex border-b border-gray-200 mb-3">
                        <button class="tab-button active" data-tab-for="s" data-mode="image">Upload Image</button>
                        <button class="tab-button" data-tab-for="s" data-mode="text">Paste Text</button>
                    </div>
                    <!-- Image Input for S -->
                    <div class="file-drop-zone w-full h-48 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-100 transition-colors"
                         id="s-drop-zone">
                        <input type="file" id="student-file" class="hidden" accept="image/*">
                        <div id="s-preview-container" class="text-center p-2">
                            <img id="s-preview" class="hidden max-h-40 mx-auto mb-2 rounded" alt="Student answer preview">
                            <span id="s-file-name" class="text-sm break-words" data-default-text="Drag & drop or click to upload">Drag & drop or click to upload</span>
                        </div>
                    </div>
                    <!-- Text Input for S -->
                    <textarea id="student-text" class="hidden w-full h-48 p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste or type student's answers here..."></textarea>
                </div>
            </div>
    
            <!-- Grading Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 items-start">
                <!-- Left Side: Profile Selection -->
                <div class="w-full">
                    <label for="grader-profile" class="block text-sm font-medium text-gray-700 mb-2">
                        Select Grader Profile
                    </label>
                    <select id="grader-profile" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="balanced">Balanced Grader (Standard)</option>
                        <option value="strict">Strict Grader (Hard Marking)</option>
                        <option value="insightful">Mentor Grader (Focus on Learning)</option>
                        <option value="custom">Custom Persona...</option>
                    </select>
                    <!-- Custom Persona Text Area (Hidden by default) -->
                    <textarea id="custom-persona-text" class="hidden w-full h-24 p-2 mt-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Be a sarcastic pirate who gives feedback..."></textarea>
                </div>
                
                <!-- Right Side: Grade Button -->
                <div class="w-full">
                    <!-- This label is a spacer to align the button -->
                    <label class="block text-sm font-medium text-transparent mb-2 hidden md:block">Ready to grade?</label>
                    <button id="grade-button" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center justify-center gap-2">
                        <!-- Rocket Icon -->
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 0 0 1-5.84 7.38v-4.82m5.84-2.56a14.98 14.98 0 0 0-5.84-2.56m0 0a14.98 14.98 0 0 1-5.84-2.56m5.84 2.56v-4.82m5.84 7.38a14.98 14.98 0 0 0 5.84-2.56m-5.84 2.56v-4.82m0 0a14.98 14.98 0 0 1 5.84-2.56m-5.84 2.56a14.98 14.98 0 0 0-5.84 2.56m0 0v-4.82L3 6.75l2.71 1.63M3 6.75l2.71-1.63M3 6.75v4.82m9.16 2.56a14.98 14.98 0 0 1-5.84 2.56m5.84-2.56V11.25m0 0a14.98 14.98 0 0 0-5.84 2.56m5.84-2.56a14.98 14.98 0 0 1-5.84-2.56m0 0v-4.82m9.16 9.18a14.98 14.98 0 0 0 5.84-2.56M12 4.82v4.82l-2.71 1.63M12 4.82l2.71-1.63M12 4.82v-4.82m0 0a14.98 14.98 0 0 1-5.84-2.56M12 4.82a14.98 14.98 0 0 0 5.84-2.56m0 0L12 3l-2.71 1.63m0 0v4.82m0 0a14.98 14.98 0 0 0 5.84 2.56m0 0L12 11.25l2.71-1.63m0 0v-4.82m0 0L12 3l2.71 1.63M12 3v4.82m0 0a14.98 14.98 0 0 1-5.84-2.56M12 3a14.98 14.98 0 0 0-5.84-2.56m0 0L3 6.75l2.71-1.63m0 0v-4.82" />
                        </svg>
                        <span id="grade-button-text">Grade Answers</span>
                        <div id="grade-spinner" class="spinner hidden"></div>
                    </button>
                </div>
            </div>
    
            <!-- Status Message Area -->
            <div id="status-message" class="hidden p-4 mb-6 text-center rounded-lg"></div>
    
            <!-- Results Container -->
            <div id="results-container">
                <!-- Grading results will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- State ---
        const inputModes = {
            q: 'image', // 'image' or 'text'
            m: 'image',
            s: 'image'
        };

        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('api-key');
        const gradeButton = document.getElementById('grade-button');
        const gradeButtonText = document.getElementById('grade-button-text');
        const gradeSpinner = document.getElementById('grade-spinner');
        const graderProfile = document.getElementById('grader-profile');
        const customPersonaText = document.getElementById('custom-persona-text');
        const statusMessage = document.getElementById('status-message');
        const resultsContainer = document.getElementById('results-container');

        // Input Elements
        const fileInputs = {
            q: document.getElementById('question-file'),
            m: document.getElementById('model-file'),
            s: document.getElementById('student-file')
        };
        const textInputs = {
            q: document.getElementById('question-text'),
            m: document.getElementById('model-text'),
            s: document.getElementById('student-text')
        };
        const dropZones = {
            q: document.getElementById('q-drop-zone'),
            m: document.getElementById('m-drop-zone'),
            s: document.getElementById('s-drop-zone')
        };
        const previews = {
            q: document.getElementById('q-preview'),
            m: document.getElementById('m-preview'),
            s: document.getElementById('s-preview')
        };
        const fileNames = {
            q: document.getElementById('q-file-name'),
            m: document.getElementById('m-file-name'),
            s: document.getElementById('s-file-name')
        };
        
        // --- Event Listeners ---
        gradeButton.addEventListener('click', startGradingProcess);

        // Grader profile listener
        graderProfile.addEventListener('change', () => {
            if (graderProfile.value === 'custom') {
                customPersonaText.classList.remove('hidden');
            } else {
                customPersonaText.classList.add('hidden');
            }
        });

        // Tab Listeners
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const type = button.dataset.tabFor; // 'q', 'm', or 's'
                const mode = button.dataset.mode; // 'image' or 'text'
                
                inputModes[type] = mode;

                // Toggle active tab style
                document.querySelectorAll(`.tab-button[data-tab-for="${type}"]`).forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                // Toggle visibility of inputs
                if (mode === 'image') {
                    dropZones[type].classList.remove('hidden');
                    textInputs[type].classList.add('hidden');
                } else {
                    dropZones[type].classList.add('hidden');
                    textInputs[type].classList.remove('hidden');
                }
            });
        });

        // File Input Listeners
        setupFileInput(fileInputs.q, dropZones.q, previews.q, fileNames.q);
        setupFileInput(fileInputs.m, dropZones.m, previews.m, fileNames.m);
        setupFileInput(fileInputs.s, dropZones.s, previews.s, fileNames.s);

        /**
         * Sets up a file input with preview and drag/drop functionality.
         */
        function setupFileInput(inputElement, dropZone, previewElement, nameElement) {
            // Click to upload
            dropZone.addEventListener('click', () => inputElement.click());

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    inputElement.files = e.dataTransfer.files;
                    showPreview(inputElement, previewElement, nameElement);
                }
            });

            // File selection change
            inputElement.addEventListener('change', () => {
                showPreview(inputElement, previewElement, nameElement);
            });
        }

        /**
         * Shows the image preview and file name.
         */
        function showPreview(input, preview, nameEl) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                nameEl.textContent = file.name;
            } else {
                preview.src = '#';
                preview.classList.add('hidden');
                nameEl.textContent = nameEl.dataset.defaultText;
            }
        }

        // --- Core Grading Logic ---

        /**
         * Gets the data for a given type (q, m, s)
         * Returns an object: { mode: 'image' | 'text', data: '...' }
         */
        async function getInputData(type) {
            const mode = inputModes[type];
            if (mode === 'image') {
                const file = fileInputs[type].files[0];
                if (!file) throw new Error(`Please upload an image for ${type.toUpperCase()}.`);
                const base64 = await fileToBase64(file);
                return { mode: 'image', data: base64, mimeType: file.type };
            } else {
                const text = textInputs[type].value.trim();
                if (!text) throw new Error(`Please enter text for ${type.toUpperCase()}.`);
                return { mode: 'text', data: text };
            }
        }
        
        /**
         * Gets the persona instructions.
         */
        function getPersonaInstructions() {
            const profile = graderProfile.value;
            let personaPrompt;

            if (profile === 'custom') {
                const customText = customPersonaText.value.trim();
                if (!customText) {
                    throw new Error("Please enter your custom persona instructions.");
                }
                personaPrompt = customText;
            } else {
                const personaPrompts = {
                    balanced: `
                        - **Grading:** Be fair and balanced. Give partial credit where due.
                        - **Feedback:** Provide constructive criticism. Clearly state what is correct and what is incorrect.
                    `,
                    strict: `
                        - **Grading:** Be meticulous and strict. Penalize any inaccuracies, omissions, or poor phrasing.
                        - **Feedback:** Be formal and direct. Start by identifying the primary flaw, then list all errors.
                    `,
                    insightful: `
                        - **Grading:** Focus on understanding, not just keywords. Be encouraging.
                        - **Feedback:** Be warm, conversational, and use "I" statements. Frame mistakes as learning opportunities.
                            - Start by finding something positive they understood.
                            - Gently explain the misunderstanding or missing part.
                            - End with an encouraging remark.
                    `
                };
                personaPrompt = personaPrompts[profile];
            }
            return { profileName: profile, instructions: personaPrompt };
        }

        /**
         * Main function to start the grading pipeline.
         */
        async function startGradingProcess() {
            setLoading(true, "Validating inputs...");
            resultsContainer.innerHTML = ''; // Clear old results

            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showStatus("Please enter your Gemini API key.", "error");
                setLoading(false);
                return;
            }

            try {
                // 1. Get Persona
                const { profileName, instructions: personaInstructions } = getPersonaInstructions();
                const profileLabel = profileName === 'custom' ? 'Custom Persona' : graderProfile.options[graderProfile.selectedIndex].text;

                // 2. Get Inputs
                setLoading(true, "Step 1/5: Reading inputs...");
                const [qInput, mInput, sInput] = await Promise.all([
                    getInputData('q'),
                    getInputData('m'),
                    getInputData('s')
                ]);

                // 3. Extract Questions
                setLoading(true, "Step 2/5: Reading question paper...");
                const questions = await extractStructuredData(
                    apiKey,
                    qInput,
                    "questions"
                );

                // 4. Extract Model Answers
                setLoading(true, "Step 3/5: Reading model answer key...");
                const modelAnswers = await extractStructuredData(
                    apiKey,
                    mInput,
                    "answers"
                );

                // 5. Merge into Question Bank
                setLoading(true, "Step 4/5: Building grading key...");
                const questionBank = mergeData(questions, modelAnswers);
                if (questionBank.length === 0) {
                    throw new Error("Could not build question bank. Check question/model answer inputs.");
                }

                // 6. Grade Student Answers
                setLoading(true, `Step 5/5: Grading as ${profileLabel}...`);
                const studentEvaluation = await getStudentEvaluation(
                    apiKey,
                    sInput,
                    questionBank,
                    personaInstructions
                );

                // 7. Display Results
                displayResults(studentEvaluation, questionBank, profileLabel);
                showStatus("Grading complete!", "success");

            } catch (error) {
                console.error(error);
                showStatus(`An error occurred: ${error.message}`, "error");
            } finally {
                setLoading(false);
            }
        }

        /**
         * Encodes a file to a Base64 string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        /**
         * Extracts structured data (questions/answers) from an image or text.
         */
        async function extractStructuredData(apiKey, input, dataType) {
            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const systemPrompt = `
You are an expert OCR and data extraction tool. Your task is to read all text from the provided input and extract it into a specific JSON format.
The user is providing ${dataType}.
You must find all ${dataType}, identify their number or ID (e.g., "Q1", "1)", "Answer 1"), and transcribe their full text content.

Follow this Chain of Thought:
1.  **Scan:** Thoroughly scan the entire input for all text.
2.  **Transcribe:** Transcribe the text accurately.
3.  **Identify:** Find all individual ${dataType} and their corresponding ID.
4.  **Structure:** Format the extracted data into the requested JSON schema.
5.  **Validate:** Ensure all extracted text is correctly placed in the JSON.
`;
            
            const inputParts = [
                { text: `Extract all ${dataType} from this input.` }
            ];

            if (input.mode === 'image') {
                inputParts.push({ inlineData: { mimeType: input.mimeType, data: input.data } });
            } else {
                inputParts.push({ text: `Here is the text: \n\n${input.data}` });
            }

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: inputParts }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "id": { "type": "STRING", "description": "The question/answer number, e.g., 'Q1' or '1'" },
                                "text": { "type": "STRING", "description": `The full text of the ${dataType}` }
                            },
                            required: ["id", "text"]
                        }
                    }
                }
            };

            const response = await apiFetchWithRetry(url, payload);
            const text = response.candidates[0].content.parts[0].text;
            return JSON.parse(text);
        }

        /**
         * Merges questions and answers into a single "question bank".
         */
        function mergeData(questions, answers) {
            const bank = [];
            for (const q of questions) {
                // Find the corresponding answer, normalizing IDs (e.g., "Q1" and "1")
                const answer = answers.find(a => normalizeId(a.id) === normalizeId(q.id));
                if (answer) {
                    bank.push({
                        id: q.id,
                        question: q.text,
                        model_answer: answer.text
                    });
                }
            }
            return bank;
        }

        /**
         * Normalizes IDs like "Q1", "1.", "Answer 1" to just "1".
         */
        function normalizeId(id) {
            return String(id).replace(/[^0-9]/g, ''); // Keep only numbers
        }

        /**
         * Gets the final evaluation for the student's answers.
         */
        async function getStudentEvaluation(apiKey, studentInput, questionBank, personaInstructions) {
            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const systemPrompt = `
You are an expert AI Grader. Your task is to evaluate a student's answers against a provided question bank.
You must read the student's answer sheet, match their answers to the questions, and provide a grade and feedback for EACH question.
You MUST grade according to the following custom persona instructions:
---
${personaInstructions}
---

Follow this exact Chain of Thought for EACH question in the question bank:

**Step 1: Parsing**
- Scan the student's input to find the answer corresponding to the question ID (e.g., "Q1" or "Answer 1").
- Transcribe/extract the student's full answer for this question.

**Step 2: Evaluation (Using Custom Persona)**
- Compare the student's answer against the provided model answer for this question.
- Apply the persona instructions *precisely*.
- Assign a grade from 0 to 10 (0=Lowest, 10=Perfect).
- Write your feedback based *only* on the persona's instructions.

**Step 3: Formatting**
- Assemble the results for this question into the specified JSON format.
- Repeat this 3-step process for ALL questions in the question bank.
- Return a JSON array containing the results for all questions.
`;
            
            const inputParts = [
                { text: `Grade the student's answers using this question bank: ${JSON.stringify(questionBank)}` }
            ];

            if (studentInput.mode === 'image') {
                inputParts.push({ inlineData: { mimeType: studentInput.mimeType, data: studentInput.data } });
            } else {
                inputParts.push({ text: `Here is the student's answer sheet text: \n\n${studentInput.data}` });
            }


            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: inputParts }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "id": { "type": "STRING", "description": "The question ID, e.g., 'Q1'" },
                                "extracted_answer": { "type": "STRING", "description": "The full transcribed text of the student's answer" },
                                "grade": { "type": "NUMBER", "description": "The grade from 1 to 10" },
                                "feedback": { "type": "STRING", "description": "The persona-driven feedback" }
                            },
                            required: ["id", "extracted_answer", "grade", "feedback"]
                        }
                    }
                }
            };

            const response = await apiFetchWithRetry(url, payload);
            const text = response.candidates[0].content.parts[0].text;
            return JSON.parse(text);
        }

        /**
         * Displays the final results in the UI.
         */
        function displayResults(evaluations, questionBank, profileLabel) {
            resultsContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    Grading Results
                </h2>
            `;

            evaluations.forEach((eval, index) => {
                const q = questionBank.find(item => normalizeId(item.id) === normalizeId(eval.id));
                if (!q) return;

                // Calculate TF-IDF Score
                const tfidfScore = calculateTfidfSimilarity(q.model_answer, eval.extracted_answer);

                const card = document.createElement('div');
                card.className = 'result-card bg-white border border-gray-200 rounded-lg shadow-md mb-6 overflow-hidden';
                // Apply animation delay
                card.style.animationDelay = `${index * 150}ms`;
                
                card.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            Question ${eval.id}: <span class="font-normal text-lg">${q.question}</span>
                        </h3>

                        <!-- Score Summary -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-sm font-medium text-blue-800 mb-1">AI GRADE</div>
                                <div class="text-4xl font-bold text-blue-700">${eval.grade}<span class="text-2xl">/10</span></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg text-center">
                                <div class="text-sm font-medium text-gray-800 mb-1">SIMILARITY SCORE</div>
                                <div class="text-4xl font-bold text-gray-700">${tfidfScore.toFixed(2)}<span class="text-2xl">/1.0</span></div>
                            </div>
                        </div>

                        <!-- Feedback -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Feedback (${profileLabel})</h4>
                            <p class="text-gray-600 leading-relaxed">${eval.feedback.replace(/\n/g, '<br>')}</p>
                        </div>
                        
                        <!-- Answer Comparison -->
                        <details class="bg-gray-50 rounded-lg p-4 cursor-pointer">
                            <summary class="font-medium text-gray-700">Show Answer Comparison</summary>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <h5 class="text-sm font-semibold text-gray-600 mb-1">Student's Answer:</h5>
                                    <p class="text-gray-800 p-3 bg-white rounded border border-gray-200">${eval.extracted_answer || "<em>No answer extracted.</em>"}</p>
                                </div>
                                <div>
                                    <h5 class="text-sm font-semibold text-gray-600 mb-1">Model Answer:</h5>
                                    <p class="text-gray-800 p-3 bg-white rounded border border-gray-200">${q.model_answer}</p>
                                </div>
                            </div>
                        </details>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });
        }

        // --- Utility Functions ---

        /**
         * Sets the loading state of the UI.
         */
        function setLoading(isLoading, message = "") {
            if (isLoading) {
                gradeButton.disabled = true;
                gradeButtonText.textContent = message;
                gradeSpinner.classList.remove('hidden');
            } else {
                gradeButton.disabled = false;
                gradeButtonText.textContent = "Grade Answers";
                gradeSpinner.classList.add('hidden');
            }
        }

        /**
         * Shows a status message (error or success).
         */
        function showStatus(message, type = "error") {
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === "error") {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            }
            statusMessage.textContent = message;
        }

        /**
         * Fetches from the API with exponential backoff retry logic.
         */
        async function apiFetchWithRetry(url, payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error ${response.status}: ${errorBody}`);
                    }

                    const data = await response.json();
                    
                    if (!data.candidates || data.candidates.length === 0) {
                        console.error("API Error: No candidates returned.", data);
                        if(data.promptFeedback && data.promptFeedback.blockReason) {
                            throw new Error(`API blocked request: ${data.promptFeedback.blockReason}`);
                        }
                        throw new Error("API returned no content. Check safety settings or prompt.");
                    }
                    
                    return data;

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed: ${error.message}`);
                    if (i === retries - 1) throw error; // Last attempt failed, re-throw
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }


        // --- TF-IDF & NLP Logic (Re-implementation of NLTK/SKLearn) ---

        const JS_STOPWORDS = new Set([
            'i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours', 'yourself', 'yourselves',
            'he', 'him', 'his', 'himself', 'she', 'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their',
            'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', 'are',
            'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'a', 'an',
            'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'of', 'at', 'by', 'for', 'with', 'about',
            'against', 'between', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up',
            'down', 'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when',
            'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no',
            'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 's', 't', 'can', 'will', 'just', 'don',
            'should', 'now'
        ]);

        /**
         * Tokenizes and preprocesses text.
         */
        function preprocess(text) {
            return text
                .toLowerCase()
                .replace(/[^\w\s]/g, '') // Remove punctuation
                .split(/\s+/) // Tokenize
                .filter(token => token && !JS_STOPWORDS.has(token)); // Remove stop words
        }

        /**
         * Calculates TF-IDF vectors for two documents.
         */
        function tfidf(doc1, doc2) {
            const corpus = [doc1, doc2];
            const processedCorpus = corpus.map(preprocess);
            
            // Build vocabulary
            const vocab = new Set();
            processedCorpus.forEach(doc => doc.forEach(token => vocab.add(token)));
            const vocabList = Array.from(vocab);
            
            // Calculate TF (Term Frequency)
            const tfDocs = processedCorpus.map(doc => {
                const tf = {};
                doc.forEach(token => {
                    tf[token] = (tf[token] || 0) + 1;
                });
                const docLen = doc.length;
                if (docLen > 0) {
                    for (const token in tf) {
                        tf[token] = tf[token] / docLen;
                    }
                }
                return tf;
            });

            // Calculate IDF (Inverse Document Frequency)
            const idf = {};
            const numDocs = corpus.length;
            vocabList.forEach(token => {
                const docsWithToken = processedCorpus.filter(doc => doc.includes(token)).length;
                idf[token] = Math.log(numDocs / (1 + docsWithToken)) + 1;
            });

            // Calculate TF-IDF
            const tfidfDocs = tfDocs.map(tf => {
                const tfidfVec = new Array(vocabList.length).fill(0);
                vocabList.forEach((token, i) => {
                    if (tf[token]) {
                        tfidfVec[i] = tf[token] * idf[token];
                    }
                });
                return tfidfVec;
            });
            
            return tfidfDocs;
        }

        /**
         * Calculates Cosine Similarity between two vectors.
         */
        function cosineSimilarity(vecA, vecB) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }
            normA = Math.sqrt(normA);
            normB = Math.sqrt(normB);
            
            if (normA === 0 || normB === 0) {
                return 0; // Avoid division by zero
            }
            return dotProduct / (normA * normB);
        }

        /**
         * Main function to get the similarity score.
         */
        function calculateTfidfSimilarity(doc1, doc2) {
            if (!doc1 || !doc2) return 0;
            
            const [vec1, vec2] = tfidf(doc1, doc2);
            return cosineSimilarity(vec1, vec2);
        }

    </script>

    <!-- This script handles the page toggle -->
    <script>
        document.getElementById('start-app-button').addEventListener('click', () => {
            document.getElementById('welcome-container').classList.add('hidden');
            document.getElementById('app-page').classList.remove('hidden');
        });
    </script>

</body>
</html>
